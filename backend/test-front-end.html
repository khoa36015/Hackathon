<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Test API Mi·ªÅn T√¢y</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e2e8f0;
    }
    body {
      margin: 0;
      display: grid;
      grid-template-columns: 280px 1fr;
      height: 100vh;
    }
    aside {
      border-right: 1px solid #1f2937;
      background: #111827;
      overflow-y: auto;
    }
    main {
      padding: 16px;
      overflow-y: auto;
    }
    h1 {
      font-size: 1.1rem;
      margin: 12px 0;
    }
    .panel {
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 12px;
      background: #0f172a;
      margin-bottom: 12px;
    }
    .input-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2937;
      background: #111827;
      color: #e2e8f0;
    }
    button {
      background: #2563eb;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #1f2937;
      cursor: not-allowed;
    }
    .province-item {
      padding: 6px 10px;
      cursor: pointer;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .province-item:hover {
      background: rgba(37, 99, 235, 0.15);
    }
    .badge {
      display: inline-block;
      background: rgba(148, 163, 184, 0.2);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 9999px;
      padding: 3px 10px;
      font-size: 0.7rem;
      margin: 2px 4px 0 0;
    }
    pre {
      background: #020617;
      padding: 10px;
      border-radius: 10px;
      overflow-x: auto;
      border: 1px solid #1f2937;
    }
    .section-title {
      font-weight: 600;
      margin-top: 10px;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: .8rem;
      opacity: .7;
    }
    .result-card {
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 8px 10px;
      margin-bottom: 6px;
      background: rgba(15, 23, 42, 0.3);
    }
  </style>
</head>
<body>
  <aside>
    <div class="panel">
      <h1>üìç Provinces</h1>
      <button onclick="loadProvinces()">Reload</button>
    </div>
    <div id="province-list"></div>
  </aside>
  <main>
    <h1>üß™ Mi·ªÅn T√¢y API Tester</h1>

    <!-- Search by name -->
    <div class="panel">
      <h2>T√¨m theo t√™n t·ªânh</h2>
      <div class="input-row">
        <input id="search-name" placeholder="v√≠ d·ª•: An Giang, C·∫ßn Th∆°..." />
        <button onclick="searchByName()">Search</button>
      </div>
      <div id="search-name-result"></div>
    </div>

    <!-- Search by hashtag -->
    <div class="panel">
      <h2>T√¨m theo hashtag</h2>
      <p class="subtitle">V√≠ d·ª•: <code>#kham_pha</code>, <code>#am_thuc</code>, <code>#tam_linh</code>, <code>#bien</code></p>
      <div class="input-row">
        <input id="search-hashtag" placeholder="#kham_pha" />
        <button onclick="searchByHashtag()">Search</button>
      </div>
      <div id="search-hashtag-result"></div>
    </div>

    <!-- Province detail -->
    <div class="panel">
      <h2>Chi ti·∫øt t·ªânh</h2>
      <div id="province-detail">Ch·ªçn 1 t·ªânh ·ªü b√™n tr√°i ƒë·ªÉ xem chi ti·∫øt.</div>
    </div>

    <!-- Raw response -->
    <div class="panel">
      <h2>Raw JSON</h2>
      <pre id="raw-json">...</pre>
    </div>
  </main>

  <script>
    const BASE_URL = "http://127.0.0.1:1311";

    async function loadProvinces() {
      const list = document.getElementById("province-list");
      list.innerHTML = "ƒêang t·∫£i...";
      try {
        const res = await fetch(`${BASE_URL}/api/provinces`);
        if (!res.ok) throw new Error("Fail to load provinces");
        const data = await res.json();
        list.innerHTML = "";
        data.forEach(p => {
          const div = document.createElement("div");
          div.className = "province-item";
          div.textContent = p.ten + " (" + p.id + ")";
          div.onclick = () => loadProvinceDetail(p.id);
          list.appendChild(div);
        });
        setRaw(data);
      } catch (err) {
        list.innerHTML = "L·ªói t·∫£i provinces: " + err.message;
      }
    }

    async function loadProvinceDetail(id) {
      const detail = document.getElementById("province-detail");
      detail.innerHTML = "ƒêang t·∫£i chi ti·∫øt " + id + "...";
      try {
        const res = await fetch(`${BASE_URL}/api/province/${id}`);
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y t·ªânh");
        const data = await res.json();
        detail.innerHTML = renderProvinceDetail(data);
        setRaw(data);
      } catch (err) {
        detail.innerHTML = "L·ªói: " + err.message;
      }
    }

    function renderProvinceDetail(p) {
      let html = `<h3>${p.ten}</h3>`;
      html += `<p>${p.mo_ta || ""}</p>`;
      // tour
      if (p.tour) {
        html += `<div class="section-title">üß≠ Tour g·ª£i √Ω</div>`;
        html += `<div class="result-card">
          <strong>${p.tour.ten || ""}</strong><br/>
          <small>${p.tour.mo_ta || ""}</small><br/>
          <small>‚è± ${p.tour.thoi_luong || ""}</small><br/>
          <small>üíµ ${p.tour.gia_tham_khao || p.tour.gia_du_kien || ""}</small>
        </div>`;
      }
      // ƒë·ªãa ƒëi·ªÉm
      if (p.dia_diem) {
        html += `<div class="section-title">üó∫ ƒê·ªãa ƒëi·ªÉm</div>`;
        Object.entries(p.dia_diem).forEach(([name, info]) => {
          html += `<div class="result-card">
            <strong>${name}</strong><br/>
            <small>${info.mo_ta || ""}</small><br/>`;
          if (info.hashtags && info.hashtags.length) {
            info.hashtags.forEach(h => {
              html += `<span class="badge">${h}</span>`;
            });
          }
          html += `</div>`;
        });
      }
      // m√≥n ƒÉn
      if (p.mon_an) {
        html += `<div class="section-title">üçú M√≥n ƒÉn</div>`;
        Object.entries(p.mon_an).forEach(([name, info]) => {
          html += `<div class="result-card">
            <strong>${name}</strong><br/>
            <small>${info.mo_ta || ""}</small><br/>`;
          if (info.hashtags && info.hashtags.length) {
            info.hashtags.forEach(h => {
              html += `<span class="badge">${h}</span>`;
            });
          }
          html += `</div>`;
        });
      }
      return html;
    }

    async function searchByName() {
      const q = document.getElementById("search-name").value.trim();
      const box = document.getElementById("search-name-result");
      if (!q) {
        box.innerHTML = "Nh·∫≠p t√™n t·ªânh tr∆∞·ªõc.";
        return;
      }
      box.innerHTML = "ƒêang t√¨m...";
      try {
        const res = await fetch(`${BASE_URL}/api/search?name=${encodeURIComponent(q)}`);
        if (!res.ok) throw new Error("Kh√¥ng t√¨m th·∫•y t·ªânh ph√π h·ª£p");
        const data = await res.json();
        box.innerHTML = "";
        data.forEach(p => {
          const card = document.createElement("div");
          card.className = "result-card";
          card.innerHTML = `<strong>${p.ten}</strong> <small>(${p.id})</small><br/>${p.mo_ta || ""}`;
          card.onclick = () => loadProvinceDetail(p.id);
          box.appendChild(card);
        });
        setRaw(data);
      } catch (err) {
        box.innerHTML = "L·ªói: " + err.message;
      }
    }

    async function searchByHashtag() {
      const q = document.getElementById("search-hashtag").value.trim();
      const box = document.getElementById("search-hashtag-result");
      if (!q) {
        box.innerHTML = "Nh·∫≠p hashtag tr∆∞·ªõc.";
        return;
      }
      box.innerHTML = "ƒêang t√¨m...";
      try {
        const res = await fetch(`${BASE_URL}/api/search/hashtag?tag=${encodeURIComponent(q)}`);
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || "Kh√¥ng t√¨m th·∫•y");
        }
        const data = await res.json();
        box.innerHTML = "";
        data.results.forEach(item => {
          const wrap = document.createElement("div");
          wrap.className = "result-card";
          let inner = `<strong>${item.province_name}</strong> <small>(${item.province_id})</small><br/>`;
          if (item.dia_diem && item.dia_diem.length) {
            inner += `<div class="section-title">ƒê·ªãa ƒëi·ªÉm:</div>`;
            item.dia_diem.forEach(d => {
              inner += `<div><strong>${d.ten}</strong></div>`;
              if (d.hashtags) {
                d.hashtags.forEach(h => inner += `<span class="badge">${h}</span>`);
              }
            });
          }
          if (item.mon_an && item.mon_an.length) {
            inner += `<div class="section-title">M√≥n ƒÉn:</div>`;
            item.mon_an.forEach(m => {
              inner += `<div><strong>${m.ten}</strong></div>`;
              if (m.hashtags) {
                m.hashtags.forEach(h => inner += `<span class="badge">${h}</span>`);
              }
            });
          }
          wrap.innerHTML = inner;
          box.appendChild(wrap);
        });
        setRaw(data);
      } catch (err) {
        box.innerHTML = "L·ªói: " + err.message;
      }
    }

    function setRaw(data) {
      const pre = document.getElementById("raw-json");
      pre.textContent = JSON.stringify(data, null, 2);
    }

    // load l√∫c m·ªü trang
    loadProvinces();
  </script>
</body>
</html>
